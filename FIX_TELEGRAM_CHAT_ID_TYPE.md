# Fix for Telegram Chat ID Type Error

## Problem
The error "operator does not exist: numeric = text" occurred because `telegram_chat_id` in the database is `numeric` type, but the function was trying to compare it with a `text` parameter.

## Solution Applied
The migration file has been updated to:
1. Convert the text `p_chat_id` parameter to `numeric` before comparison
2. Compare `telegram_chat_id` (numeric) with the numeric value
3. Also check `telegram_user_id` (text) as a fallback

## Next Steps

### 1. Run the Updated Migration

Go to Supabase Dashboard â†’ SQL Editor and run the updated migration:

**File**: `supabase/migrations/20251109000001_create_automation_ticket_function.sql`

Or copy and paste this SQL:

```sql
-- Fix the function to handle telegram_chat_id as numeric type
CREATE OR REPLACE FUNCTION create_ticket_from_automation(
  p_issue text,
  p_location text,
  p_category text,
  p_priority text,
  p_user_name text,
  p_chat_id text,
  p_tenant_id uuid,
  p_designation text DEFAULT NULL,
  p_department text DEFAULT NULL,
  p_type text DEFAULT 'Maintenance',
  p_building text DEFAULT NULL,
  p_floor text DEFAULT NULL,
  p_room text DEFAULT NULL
)
RETURNS json
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_user_id uuid;
  v_ticket_id uuid;
  v_ticket_number text;
  v_chat_id_numeric numeric;
BEGIN
  -- Validate priority
  IF p_priority NOT IN ('critical', 'high', 'medium', 'low') THEN
    RETURN json_build_object(
      'success', false,
      'error', 'Invalid priority. Must be one of: critical, high, medium, low'
    );
  END IF;

  -- Convert chat_id from text to numeric (telegram_chat_id column is numeric)
  BEGIN
    v_chat_id_numeric := p_chat_id::numeric;
  EXCEPTION
    WHEN OTHERS THEN
      RETURN json_build_object(
        'success', false,
        'error', format('Invalid chat_id format: %s. Must be a numeric value.', p_chat_id)
      );
  END;

  -- Find user by chat_id
  -- telegram_chat_id is numeric, so compare numeric to numeric
  SELECT id INTO v_user_id
  FROM users
  WHERE (
    telegram_chat_id = v_chat_id_numeric
    OR telegram_user_id = p_chat_id  -- Also check telegram_user_id (text) as fallback
  )
    AND tenant_id = p_tenant_id
    AND is_active = true
  LIMIT 1;

  IF v_user_id IS NULL THEN
    RETURN json_build_object(
      'success', false,
      'error', format('User not found with chat_id: %s in tenant: %s', p_chat_id, p_tenant_id)
    );
  END IF;

  -- Create ticket (ticket_number will be auto-generated by trigger)
  INSERT INTO tickets (
    title,
    description,
    category,
    priority,
    type,
    location,
    building,
    floor,
    room,
    complainant_id,
    tenant_id,
    status,
    created_at,
    updated_at
  ) VALUES (
    trim(p_issue),
    trim(p_issue),
    trim(p_category),
    p_priority,
    COALESCE(trim(p_type), 'Maintenance'),
    trim(p_location),
    CASE WHEN p_building IS NOT NULL THEN trim(p_building) ELSE NULL END,
    CASE WHEN p_floor IS NOT NULL THEN trim(p_floor) ELSE NULL END,
    CASE WHEN p_room IS NOT NULL THEN trim(p_room) ELSE NULL END,
    v_user_id,
    p_tenant_id,
    'open',
    now(),
    now()
  )
  RETURNING id, ticket_number INTO v_ticket_id, v_ticket_number;

  -- Return success with ticket details
  RETURN json_build_object(
    'success', true,
    'ticket_id', v_ticket_id,
    'ticket_number', v_ticket_number,
    'message', 'Ticket created successfully'
  );

EXCEPTION
  WHEN OTHERS THEN
    RETURN json_build_object(
      'success', false,
      'error', 'Failed to create ticket: ' || SQLERRM
    );
END;
$$;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION create_ticket_from_automation TO authenticated;
GRANT EXECUTE ON FUNCTION create_ticket_from_automation TO anon;

-- Refresh schema cache
NOTIFY pgrst, 'reload schema';
```

### 2. Wait for Schema Cache Refresh
Wait 10-30 seconds after running the SQL for the schema cache to refresh.

### 3. Test Again
Test your API call in Make or Postman. It should now work correctly!

## What Changed

**Before:**
```sql
WHERE telegram_chat_id = p_chat_id  -- Error: numeric = text
```

**After:**
```sql
-- Convert text to numeric first
v_chat_id_numeric := p_chat_id::numeric;

-- Then compare numeric to numeric
WHERE (
  telegram_chat_id = v_chat_id_numeric
  OR telegram_user_id = p_chat_id  -- Fallback check
)
```

## Verification

After running the migration, verify the function works:

```sql
-- Test the function
SELECT create_ticket_from_automation(
  'Test issue',
  'Test location',
  'IT',
  'medium',
  'Test User',
  '123456789',  -- This will be converted to numeric
  'your-tenant-uuid'::uuid
);
```

You should get a JSON response with `"success": true` or an error message if the user doesn't exist.

