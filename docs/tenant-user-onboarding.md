# Tenant User Onboarding (Complainant & Executor)

## Overview
- When a tenant admin creates a complainant or executor, we generate a *user onboarding request*.
- The onboarding request kicks off the Make automation that emails a Telegram deep link invite.
- The onboarding flow is **complete only when a Telegram `chat_id` is confirmed**.
- Every state change is reflected as a notification inside the tenant admin dashboard.

## Webhook Payload Contract
The tenant admin portal sends a JSON payload to the onboarding webhook service.

| Field | Type | Notes |
| --- | --- | --- |
| `event_type` | string | Always `tenant.user.onboarding_requested` (allows future events) |
| `tenant_id` | string (UUID) | Required for routing and RLS checks |
| `tenant_name` | string | Display in notifications & email |
| `user_id` | string (UUID) | Internal Supabase `users.id` created for the complainant/executor |
| `user_role` | `'executor' \| 'complainant'` | Drives Make branching & messaging |
| `email` | string | Primary contact, used to email the deep link |
| `full_name` | string | Optional, improves email copy & notifications |
| `employee_id` | string | Optional metadata shown to admins |
| `initiated_by` | object | `{ id: string; email: string; name?: string }` identifying the tenant admin |
| `correlation_id` | string | UUID generated when creating the onboarding request, passed end-to-end |
| `requested_at` | string (ISO timestamp) | When the request originated |

> **Note:** Phone number is no longer part of the payload; email is the canonical contact.

### Response
- `202 Accepted` with body `{ status: 'queued', correlation_id: string }` when the request is validated & queued.
- `400/401/403/409` with structured error body when validation fails.

## Persistence Updates

### `users` table additions
| Column | Type | Default | Purpose |
| --- | --- | --- | --- |
| `bot_onboarding_status` | text | `'pending'` | Current state of the Telegram onboarding handshake |
| `bot_onboarding_started_at` | timestamptz | `now()` via trigger | First time we queued Make |
| `bot_onboarding_completed_at` | timestamptz | null | Set when `chat_id` is confirmed |
| `bot_onboarding_error` | text | null | Stores latest failure message (e.g. Make webhook rejection) |
| `bot_onboarding_retry_count` | integer | `0` | Incremented for API retries |
| `bot_deep_link` | text | null | Copy of the most recent deep link generated by Make (optional) |
| `bot_correlation_id` | uuid | null | Links Make call & callback |

Existing `telegram_chat_id` continues to hold the confirmed chat id. `is_active` remains unchanged until onboarding ends successfully.

### `tenant_notifications` table (new)
| Column | Type | Notes |
| --- | --- | --- |
| `id` | uuid | `uuid_generate_v4()` |
| `tenant_id` | uuid | FK → `tenants.id` |
| `user_id` | uuid | Optional (who the notification is about) |
| `triggered_by` | uuid | Optional (admin who initiated) |
| `type` | text | e.g. `onboarding`, `onboarding.error`, `onboarding.timeout` |
| `title` | text | Short headline |
| `message` | text | Detailed copy for dashboard |
| `level` | text | `info` \| `success` \| `warning` \| `error` |
| `status` | text | `unread` (default) \| `read` |
| `metadata` | jsonb | Misc data (correlation id, email, role, retry counts) |
| `created_at` | timestamptz | `now()` |
| `read_at` | timestamptz | null |

RLS: tenant admins can read notifications within their tenant; only service role can insert.

### Event Log (optional enhancement)
- `user_onboarding_events` table can capture each transition, but not required for v1; we rely on notifications + user columns.

## Notification Lifecycle
1. **Queued** – “Onboarding started for `<email>`” (`info`)
2. **Invite Sent** – Email successfully sent (`info`)
3. **Awaiting Chat** – Make waiting for bot start (`info`, optional)
4. **Completed** – `chat_id` stored; user marked active (`success`)
5. **Retry** – Failure/timeout, auto retry scheduled (`warning`)
6. **Failed** – Manual action required (`error`)

Notifications reference the `correlation_id` and include action hints (e.g., “Resend invite”).

## Make Automation Overview
1. **Webhook (Receive)** – Accept payload, validate signature.
2. **Generate Deep Link** – Use Telegram Bot API `exportChatInviteLink` or manual `https://t.me/<bot>?start=<token>`.
3. **Send Email** – Email module delivers invite with the deep link & tenant context.
4. **Wait for User Start** – Either via Telegram bot webhook pushed back into Make, or polling a Supabase table that the bot updates.
5. **Callback Supabase** – POST to `/user-onboarding/callback` with `{ correlation_id, email, chat_id, telegram_user_id? }`.
6. **Handle Failures** – On exception, call `/user-onboarding/callback` with `{ status: 'failed', error }`.

Retries: Make retries transient failures (HTTP 5xx) automatically. For functional errors (invalid email), fire a failure callback so we can notify tenant admins.

## Backend Flow Summary
1. **User Creation** – Tenant admin creates complainant/executor via UI.
2. **Emit Onboarding Request** – Frontend calls `POST /user-onboarding/request` edge function with payload + JWT.
3. **Webhook Service** – Edge function:
   - Validates JWT (must be tenant admin).
   - Stores pending state in `users` row (`bot_onboarding_status='pending'`, `correlation_id`).
   - Inserts “Queued” notification.
   - Forwards payload to Make webhook (with retries & exponential backoff).
4. **Invite Email** – Make sends deep link email.
5. **User Clicks Link** – Telegram bot notifies Make; Make calls backend callback.
6. **Callback Endpoint** – Updates user (`telegram_chat_id`, `status='completed'`), marks notification as success, optionally toggles `is_active=true`.
7. **Tenant Admin Dashboard** – Polls notifications & highlights pending/failed onboarding states.

## Pending vs Active
- Keep users `is_active=false` until `bot_onboarding_status='completed'`.
- Provide manual override: tenant admins can force-complete (future enhancement).

## Edge Function Environment Variables
Configure these secrets in Supabase:

| Key | Purpose |
| --- | --- |
| `MAKE_USER_ONBOARDING_WEBHOOK_URL` | Make scenario webhook that accepts onboarding requests |
| `MAKE_ONBOARDING_CALLBACK_TOKEN` *(optional)* | Shared secret for Make → Supabase callback (falls back to service role key if omitted) |
| `SUPABASE_SERVICE_ROLE_KEY` | Required by edge functions for privileged queries |

## Timeout Handling
- After X hours without callback, automation calls failure endpoint with reason `timeout`.
- Backend marks status `failed`, increments retry count, queues notification with escalation guidance.
- Tenant admins can retry by clicking “Resend invite” (fires new correlation ID, increments retry count).

## Audit & Observability
- Log payloads (sans PII) with `console.info` in edge functions for Supabase logs.
- Include `correlation_id` in every log line across services, Make scenario, and notifications.
- Make scenario should capture run history for troubleshooting.

## Testing Notes
- Mock Make webhook locally by pointing to a requestbin to verify payload shape.
- Use Supabase Edge function local dev (`supabase functions serve`) to test request/response.
- Validate email deep link using Telegram’s test accounts.
- Ensure notifications render correctly in dashboard (list API, mark read).


